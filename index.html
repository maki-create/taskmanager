<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Manager</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- カスタムカラーパレット（くすみブルー）の設定 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'dusty-blue': {
              50: '#f2f6f8',
              100: '#dfe8ed',
              200: '#c2d5e0',
              300: '#99bcce',
              400: '#6a9db6',
              500: '#52839d',
              600: '#466a81',
              700: '#3a566a',
              800: '#334858',
              900: '#2e3e4b',
            }
          }
        }
      }
    }
  </script>
  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* スクロールバー非表示 */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* ローディングスピナー */
    .spinner {
      border: 2px solid #dfe8ed;
      border-top: 2px solid #52839d;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans pb-24 min-h-screen">

  <!-- ヘッダー -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="w-8"></div><!-- Spacer -->
      <!-- ビュー切り替えタブ -->
      <div class="flex bg-gray-100 p-1 rounded-lg">
        <button id="tab-list" onclick="setView('list')" class="flex items-center gap-2 px-6 py-2 rounded-md text-sm font-medium transition-colors text-gray-500 hover:text-gray-700">
          <i data-lucide="list" class="w-4 h-4"></i>
          未実行一覧
        </button>
        <button id="tab-calendar" onclick="setView('calendar')" class="flex items-center gap-2 px-6 py-2 rounded-md text-sm font-medium transition-colors bg-white shadow-sm text-dusty-blue-600">
          <i data-lucide="calendar" class="w-4 h-4"></i>
          カレンダー
        </button>
      </div>
      <!-- 同期中インジケーター -->
      <div class="w-8 flex justify-end items-center">
        <div id="sync-indicator" class="spinner hidden" title="同期中..."></div>
      </div>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="max-w-4xl mx-auto px-4 mt-6">
    <!-- リストビュー -->
    <div id="view-list" class="hidden"></div>

    <!-- カレンダービュー -->
    <div id="view-calendar">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <!-- カレンダーヘッダー -->
        <div class="p-4 flex justify-between items-center border-b border-gray-100">
          <button onclick="prevMonth()" class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600">
            <i data-lucide="chevron-left" class="w-5 h-5"></i>
          </button>
          <h2 id="calendar-title" class="text-lg font-bold text-gray-800"></h2>
          <button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600">
            <i data-lucide="chevron-right" class="w-5 h-5"></i>
          </button>
        </div>
        
        <!-- 曜日 -->
        <div class="grid grid-cols-7 bg-gray-50 border-b border-gray-100">
          <div class="py-2 text-center text-xs font-medium text-red-500">日</div>
          <div class="py-2 text-center text-xs font-medium text-gray-500">月</div>
          <div class="py-2 text-center text-xs font-medium text-gray-500">火</div>
          <div class="py-2 text-center text-xs font-medium text-gray-500">水</div>
          <div class="py-2 text-center text-xs font-medium text-gray-500">木</div>
          <div class="py-2 text-center text-xs font-medium text-gray-500">金</div>
          <div class="py-2 text-center text-xs font-medium text-dusty-blue-500">土</div>
        </div>
        
        <!-- 日付グリッド -->
        <div id="calendar-grid" class="grid grid-cols-7 auto-rows-[minmax(70px,_auto)] sm:auto-rows-[minmax(90px,_auto)]"></div>
      </div>
    </div>
  </main>

  <!-- カレンダー詳細ボトムシート -->
  <div id="day-detail-modal" class="hidden fixed inset-0 z-30 flex flex-col justify-end" onclick="closeDayDetailModal()">
    <div id="day-detail-backdrop" class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity duration-300 opacity-0"></div>
    <div id="day-detail-sheet" class="relative bg-white rounded-t-3xl shadow-2xl w-full max-w-4xl mx-auto overflow-hidden flex flex-col max-h-[85vh] transform translate-y-full transition-transform duration-300 ease-out" onclick="event.stopPropagation()">
      <div class="w-full flex justify-center pt-3 pb-2 bg-gray-50 cursor-pointer" onclick="closeDayDetailModal()">
        <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
      </div>
      <div class="flex justify-between items-center px-5 py-2 border-b border-gray-100 bg-gray-50">
        <h3 id="day-detail-title" class="font-bold text-gray-800 flex items-center gap-2"></h3>
        <button onclick="closeDayDetailModal()" class="p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded-full transition-colors">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="day-detail-content" class="p-5 overflow-y-auto space-y-3 bg-white pb-12 no-scrollbar">
      </div>
    </div>
  </div>

  <!-- 新規追加ボタン -->
  <button onclick="openModal()" class="fixed bottom-8 right-8 w-14 h-14 bg-dusty-blue-500 hover:bg-dusty-blue-600 text-white rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95 z-20" aria-label="タスクを追加">
    <i data-lucide="plus" class="w-7 h-7"></i>
  </button>

  <!-- 新規タスク追加モーダル -->
  <div id="add-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex justify-center items-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
      <div class="flex justify-between items-center p-5 border-b border-gray-100">
        <h2 class="text-xl font-bold text-gray-800">新規タスクの追加</h2>
        <button onclick="closeModal()" class="p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="p-5 overflow-y-auto no-scrollbar">
        <form id="add-task-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">カテゴリ</label>
            <select id="task-category" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 focus:border-dusty-blue-400 outline-none transition-all bg-white font-medium text-gray-700">
              <option value="その他">その他 (デフォルト)</option>
              <option value="仕事">仕事</option>
              <option value="日常">日常</option>
            </select>
          </div>
          <div id="dueDate-section-specific">
            <label class="block text-sm font-medium text-gray-700 mb-1">期日 (時間指定)</label>
            <input type="datetime-local" id="task-dueDate-specific" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 focus:border-dusty-blue-400 outline-none transition-all">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">繰り返し設定</label>
            <select id="task-type" onchange="handleTypeChange()" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 focus:border-dusty-blue-400 outline-none transition-all bg-white font-medium text-dusty-blue-700">
              <option value="specific">繰り返しなし</option>
              <option value="daily">毎日</option>
              <option value="weekly">毎週</option>
              <option value="biweekly">2週間おき</option>
              <option value="triweekly">3週間おき</option>
              <option value="monthly">毎月</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">なにをするか <span class="text-red-500">*</span></label>
            <input type="text" id="task-title" required placeholder="例: 打ち合わせ資料の作成" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 focus:border-dusty-blue-400 outline-none transition-all">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">内容</label>
            <input type="text" id="task-content" placeholder="例: A社向けの提案書ドラフトを完成させる" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 focus:border-dusty-blue-400 outline-none transition-all">
          </div>
          
          <div id="dueDate-section-specific">
            <label class="block text-sm font-medium text-gray-700 mb-1">期日 (時間指定) <span class="text-red-500">*</span></label>
            <input type="datetime-local" id="task-dueDate-specific" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 focus:border-dusty-blue-400 outline-none transition-all">
          </div>

          <div id="dueDate-section-recurring" class="hidden bg-dusty-blue-50/50 p-4 rounded-lg border border-dusty-blue-100">
            <label class="block text-sm font-medium text-gray-700 mb-2">期日の決め方 <span class="text-red-500">*</span></label>
            <div class="flex flex-col gap-3 mb-2">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="dueDateOption" value="loose" checked onchange="handleDueDateOptionChange()" class="w-4 h-4 text-dusty-blue-500 focus:ring-dusty-blue-400">
                <span id="loose-label-text" class="text-sm font-medium text-gray-800">その日中</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="dueDateOption" value="exact" onchange="handleDueDateOptionChange()" class="w-4 h-4 text-dusty-blue-500 focus:ring-dusty-blue-400">
                <span class="text-sm font-medium text-gray-800">特定の日時から指定する</span>
              </label>
            </div>
            <div id="dueDate-exact-container" class="hidden mt-3 pt-3 border-t border-dusty-blue-100">
              <input type="datetime-local" id="task-dueDate-recurring" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 focus:border-dusty-blue-400 outline-none transition-all bg-white">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">メモ (URLは自動でリンクになります)</label>
            <textarea id="task-memo" rows="3" placeholder="関連リンクや補足情報など&#10;例: https://google.com" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 focus:border-dusty-blue-400 outline-none transition-all resize-none"></textarea>
          </div>
        </form>
      </div>

      <div class="p-5 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
        <button type="button" onclick="closeModal()" class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">キャンセル</button>
        <button type="submit" id="submit-btn" form="add-task-form" class="px-5 py-2.5 text-sm font-medium text-white bg-dusty-blue-500 rounded-lg hover:bg-dusty-blue-600 transition-colors shadow-sm">登録する</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // API通信設定 (GASのURLをここに貼る)
    // ==========================================
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyNJU9XMMYJOBD_E7412_yNHtGNI4CyaU9jKL3w6nD6iK7L2kDFUoAohoXGZEC9aSbbWg/exec';

    // 状態管理
    let tasks = [];
    let currentView = 'calendar';
    let currentDate = new Date();
    let selectedDate = null;
    let isSyncing = false;
    let editingTaskId = null;
    let currentListTab = 'すべて'; 
    // ★追加: タブ切り替え用関数
    function setListTab(tab) {
      currentListTab = tab;
      renderList();
    }

    // --- APIラッパー ---
    async function fetchAPI(action, payload = {}) {
      setSyncing(true);
      try {
        const res = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          redirect: 'follow',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: action, ...payload })
        });
        const json = await res.json();
        if (json.status === 'error') throw new Error(json.message);
        return json.data;
      } finally {
        setSyncing(false);
      }
    }

    function setSyncing(status) {
      isSyncing = status;
      const indicator = document.getElementById('sync-indicator');
      if (status) indicator.classList.remove('hidden');
      else indicator.classList.add('hidden');
    }

    // --- 初期化 ---
    document.addEventListener('DOMContentLoaded', () => {
      const nowIso = getLocalIsoDateTime();
      document.getElementById('task-dueDate-specific').value = nowIso;
      document.getElementById('task-dueDate-recurring').value = nowIso;
      
      loadAllTasks();

      // フォーム送信
      document.getElementById('add-task-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = document.getElementById('task-title').value;
        if (!title.trim()) return;

        const type = document.getElementById('task-type').value;
        let dueDate = '';

        if (type === 'specific') {
          dueDate = document.getElementById('task-dueDate-specific').value;
        } else {
          const option = document.querySelector('input[name="dueDateOption"]:checked').value;
          if (option === 'exact') {
            dueDate = document.getElementById('task-dueDate-recurring').value;
          } else {
            const now = new Date();
            if (type === 'daily') now.setHours(23, 59, 0, 0);
            else if (['weekly', 'biweekly', 'triweekly'].includes(type)) {
              const diff = now.getDay() === 0 ? 0 : 7 - now.getDay();
              now.setDate(now.getDate() + diff);
              now.setHours(23, 59, 0, 0);
            } else if (type === 'monthly') {
              now.setMonth(now.getMonth() + 1, 0);
              now.setHours(23, 59, 0, 0);
            }
            dueDate = getLocalIsoDateTime(now);
          }
        }

        // --- ここからが新規追加と編集の分岐 ---
        if (editingTaskId) {
          // ★ 編集モードの処理
          const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
          if (taskIndex !== -1) {
            // 画面上のデータを上書き
            tasks[taskIndex].title = title;
            tasks[taskIndex].content = document.getElementById('task-content').value;
            tasks[taskIndex].dueDate = dueDate;
            tasks[taskIndex].type = type;
            tasks[taskIndex].memo = document.getElementById('task-memo').value;
            
            const updatedTask = tasks[taskIndex];
            
            // 画面を更新
            closeModal();
            updateApp();
            if (selectedDate) renderDayDetailModalContent();
            
            // 裏でAPI送信（GASへ更新リクエスト）
            try {
              await fetchAPI('editTask', { task: updatedTask });
              await fetchFromServer();
            } catch (error) {
              alert('更新に失敗しました。');
              await loadAllTasks();
            }
          }
        } else {
          const newTask = {
            id: Date.now(),
            title,
            content: document.getElementById('task-content').value,
            dueDate,
            type,
            memo: document.getElementById('task-memo').value,
            registerDate: getLocalIsoDateTime().slice(0, 10),
            completed: false,
            count: 0
          };

          // 画面にすぐ追加
          tasks.push(newTask);
          closeModal();
          updateApp();
          e.target.reset();
          document.getElementById('task-type').value = 'specific';
          handleTypeChange();
          
          // 裏でAPI送信（GASへ新規追加リクエスト）
          try {
            await fetchAPI('addTask', { task: newTask });
            await fetchFromServer();
          } catch (error) {
            alert('登録に失敗しました。画面をリロードします。');
            await loadAllTasks();
          }
        }
      });
    }); 


    // --- データ取得ロジック ---
    async function loadAllTasks() {
      // 1. キャッシュから即時表示
      const cached = localStorage.getItem('task_manager_cache');
      if (cached) {
        try {
          tasks = JSON.parse(cached);
          updateApp();
        } catch(e){}
      }
      // 2. サーバーから最新を取得
      await fetchFromServer();
    }

    async function fetchFromServer() {
      if (GAS_WEB_APP_URL === 'YOUR_GAS_WEB_APP_URL_HERE') return; // API設定前はモックデータで遊べるように
      try {
        const serverTasks = await fetchAPI('getTasks');
        tasks = serverTasks;
        localStorage.setItem('task_manager_cache', JSON.stringify(tasks));
        updateApp();
      } catch (e) {
        console.error('Fetch error:', e);
      }
    }

    // --- タスク操作（楽観的UI更新） ---
    async function completeTask(id) {
      // 画面上から消す
      tasks = tasks.filter(t => t.id !== id);
      updateApp();
      if (selectedDate) renderDayDetailModalContent();

      // 裏でAPI送信
      try {
        await fetchAPI('completeTask', { id });
        await fetchFromServer(); // 自動生成された次回のタスクを取ってくる
      } catch(e) {
        alert('エラーが発生しました');
        await fetchFromServer();
      }
    }

    async function deleteTask(id) {
      // 画面上から消す
      tasks = tasks.filter(t => t.id !== id);
      updateApp();
      if (selectedDate) renderDayDetailModalContent();

      // 裏でAPI送信
      try {
        await fetchAPI('deleteTask', { id });
        await fetchFromServer();
      } catch(e) {
        alert('エラーが発生しました');
        await fetchFromServer();
      }
    }

    // --- UI操作関数群 ---
    const getLocalIsoDateTime = (d = new Date()) => {
      const tzOffset = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - tzOffset).toISOString().slice(0, 16);
    };

    function handleTypeChange() {
      const type = document.getElementById('task-type').value;
      const sectionSpecific = document.getElementById('dueDate-section-specific');
      const sectionRecurring = document.getElementById('dueDate-section-recurring');
      const looseLabel = document.getElementById('loose-label-text');
      const specificInput = document.getElementById('task-dueDate-specific');

      if (type === 'specific') {
        sectionSpecific.classList.remove('hidden');
        sectionRecurring.classList.add('hidden');
        specificInput.required = true;
      } else {
        sectionSpecific.classList.add('hidden');
        sectionRecurring.classList.remove('hidden');
        specificInput.required = false;
        if (type === 'daily') looseLabel.textContent = 'その日中 (今日23:59まで)';
        else if (type === 'weekly' || type === 'biweekly' || type === 'triweekly') looseLabel.textContent = 'その週中 (今週日曜23:59まで)';
        else if (type === 'monthly') looseLabel.textContent = 'その月中 (今月末23:59まで)';
      }
    }

    function handleDueDateOptionChange() {
      const isExact = document.querySelector('input[name="dueDateOption"]:checked').value === 'exact';
      const exactContainer = document.getElementById('dueDate-exact-container');
      const recurringInput = document.getElementById('task-dueDate-recurring');
      if (isExact) {
        exactContainer.classList.remove('hidden');
        recurringInput.required = true;
      } else {
        exactContainer.classList.add('hidden');
        recurringInput.required = false;
      }
    }

    function updateApp() {
      if (currentView === 'list') {
        document.getElementById('view-list').classList.remove('hidden');
        document.getElementById('view-calendar').classList.add('hidden');
        renderList();
      } else {
        document.getElementById('view-list').classList.add('hidden');
        document.getElementById('view-calendar').classList.remove('hidden');
        renderCalendar();
      }
      lucide.createIcons();
    }

    // タイトルからキーワードを検知して自動でラベルを返す関数
    function getAutoCategoryLabel(title) {
      if (!title) return '';
      // ここに好きなキーワードと色の設定を追加できます
      const rules = [
        { keywords: ['会議', 'mtg', 'ミーティング', '打合'], name: '会議', classes: 'bg-red-100 text-red-700 border-red-200' },
        { keywords: ['開発', '実装', 'コード', 'バグ', '修正'], name: '開発', classes: 'bg-blue-100 text-blue-700 border-blue-200' },
        { keywords: ['資料', '提案書', '作成'], name: '資料作成', classes: 'bg-emerald-100 text-emerald-700 border-emerald-200' },
        { keywords: ['連絡', 'メール', '電話', '確認'], name: '連絡・確認', classes: 'bg-amber-100 text-amber-700 border-amber-200' },
        { keywords: ['重要', '至急'], name: '重要', classes: 'bg-purple-100 text-purple-700 border-purple-200 font-bold' }
      ];

      for (let rule of rules) {
        if (rule.keywords.some(kw => title.toLowerCase().includes(kw))) {
          return `<span class="text-[10px] px-2 py-0.5 border rounded-full ${rule.classes}">${rule.name}</span>`;
        }
      }
      return ''; // 当てはまらない場合は何も出さない
    }

    function setView(view) {
      currentView = view;
      const tabList = document.getElementById('tab-list');
      const tabCal = document.getElementById('tab-calendar');
      const activeClass = "flex items-center gap-2 px-6 py-2 rounded-md text-sm font-medium transition-colors bg-white shadow-sm text-dusty-blue-600";
      const inactiveClass = "flex items-center gap-2 px-6 py-2 rounded-md text-sm font-medium transition-colors text-gray-500 hover:text-gray-700";

      if (view === 'list') {
        tabList.className = activeClass;
        tabCal.className = inactiveClass;
      } else {
        tabCal.className = activeClass;
        tabList.className = inactiveClass;
      }
      updateApp();
    }

    function renderList() {
      const container = document.getElementById('view-list');
      const activeTasks = tasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

      if (activeTasks.length === 0) {
        container.innerHTML = `<div class="text-center py-20 bg-white rounded-xl shadow-sm border border-gray-100"><div class="text-gray-300 flex justify-center mb-4"><i data-lucide="check" class="w-12 h-12"></i></div><h2 class="text-lg font-medium text-gray-600">未実行のタスクはありません</h2></div>`;
        return;
      }

      let html = '<div class="space-y-4">';
      activeTasks.forEach(task => {
        html += `
          <div class="bg-white p-4 sm:p-5 rounded-xl shadow-sm border border-gray-100 flex gap-4 transition-all hover:shadow-md hover:border-dusty-blue-200 group">
            <div class="pt-1">
              <button onclick="completeTask(${task.id})" class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-transparent hover:border-dusty-blue-500 hover:text-dusty-blue-500 transition-colors"><i data-lucide="check" class="w-3.5 h-3.5" stroke-width="3"></i></button>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2">
                <div>
                  <div class="flex items-center gap-2 mb-1">
                    <h3 class="font-bold text-gray-800 text-lg">${escapeHTML(task.title)}</h3>
                    ${getAutoCategoryLabel(task.title)} <span class="text-xs px-2 py-0.5 bg-dusty-blue-50 text-dusty-blue-600 rounded-full">${getTypeLabel(task.type)}</span>
                  </div>
                  ${task.content ? `<p class="text-gray-600 text-sm">${escapeHTML(task.content)}</p>` : ''}
                </div>
                <div class="flex-shrink-0">
                  <div class="text-xs font-medium px-2.5 py-1 rounded-md flex items-center gap-1 ${getDueDateColor(task.dueDate)}">
                    <i data-lucide="calendar" class="w-3 h-3"></i>${formatDateTime(task.dueDate)}
                  </div>
                </div>
              </div>
              ${renderMemoLink(task.memo)}
            </div>
            <div class="pt-1 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0 flex gap-1">
              <button onclick="openEditModal(${task.id})" class="p-1.5 text-gray-400 hover:text-dusty-blue-500 hover:bg-dusty-blue-50 rounded-md transition-colors"><i data-lucide="edit-2" class="w-4.5 h-4.5"></i></button>
              <button onclick="deleteTask(${task.id})" class="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors"><i data-lucide="trash-2" class="w-4.5 h-4.5"></i></button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      document.getElementById('calendar-title').textContent = `${year}年 ${month + 1}月`;

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const firstDayOfMonth = new Date(year, month, 1).getDay();
      const todayString = getLocalIsoDateTime().slice(0, 10);

      let gridHtml = '';
      for (let i = 0; i < firstDayOfMonth; i++) gridHtml += `<div class="border-b border-r border-gray-100 bg-gray-50/50"></div>`;

      for (let i = 1; i <= daysInMonth; i++) {
        const d = new Date(year, month, i);
        const dateString = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
        const isToday = dateString === todayString;
        const dateTasks = tasks.filter(t => t.dueDate.startsWith(dateString));

        let taskHtml = '';
        dateTasks.forEach(task => {
          taskHtml += `<div class="text-[9px] sm:text-[10px] truncate px-1 py-0.5 rounded bg-dusty-blue-100 text-dusty-blue-700">${escapeHTML(task.title)}</div>`;
        });

        gridHtml += `
          <div onclick="selectDate('${dateString}')" class="border-b border-r border-gray-100 p-1 relative group hover:bg-dusty-blue-50/50 cursor-pointer transition-colors overflow-hidden">
            <div class="flex justify-between items-start">
              <span class="text-xs sm:text-sm font-medium w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-dusty-blue-500 text-white shadow-sm' : 'text-gray-700'}">${i}</span>
            </div>
            <div class="flex flex-col gap-1 mt-1">${taskHtml}</div>
          </div>
        `;
      }
      document.getElementById('calendar-grid').innerHTML = gridHtml;
    }

    function prevMonth() { currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1); updateApp(); }
    function nextMonth() { currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1); updateApp(); }
    
    function selectDate(dateString) {
      selectedDate = dateString;
      renderDayDetailModalContent();
      document.getElementById('day-detail-modal').classList.remove('hidden');
      requestAnimationFrame(() => {
        document.getElementById('day-detail-backdrop').classList.remove('opacity-0');
        document.getElementById('day-detail-sheet').classList.remove('translate-y-full');
      });
    }

    function closeDayDetailModal() {
      document.getElementById('day-detail-backdrop').classList.add('opacity-0');
      document.getElementById('day-detail-sheet').classList.add('translate-y-full');
      setTimeout(() => {
        document.getElementById('day-detail-modal').classList.add('hidden');
        selectedDate = null;
      }, 300);
    }

    function renderDayDetailModalContent() {
      if (!selectedDate) return;
      const contentContainer = document.getElementById('day-detail-content');
      document.getElementById('day-detail-title').innerHTML = `<i data-lucide="calendar" class="w-5 h-5 text-dusty-blue-500"></i> ${formatDateSimple(selectedDate)} のタスク`;
      
      const dateTasks = tasks.filter(t => t.dueDate.startsWith(selectedDate)).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
      
      let html = '';
      if (dateTasks.length === 0) {
        html = `<div class="text-center py-8 text-gray-500"><p>この日のタスクはありません。</p></div>`;
      } else {
        dateTasks.forEach(task => {
          const timeString = task.dueDate.split('T')[1];
          html += `
            <div class="p-3.5 rounded-lg border bg-white border-dusty-blue-200 shadow-sm transition-all">
              <div class="flex items-start gap-3">
                <button onclick="event.stopPropagation(); completeTask(${task.id})" class="mt-0.5 w-5 h-5 rounded border flex items-center justify-center transition-colors border-gray-300 text-transparent hover:border-dusty-blue-500 hover:text-dusty-blue-500"><i data-lucide="check" class="w-3 h-3" stroke-width="3"></i></button>
                <div class="flex-1 min-w-0">
                  <div class="flex justify-between items-start gap-2">
                    <div class="flex items-center gap-2 flex-wrap">
                      <h4 class="font-medium text-gray-800 text-base break-words">${escapeHTML(task.title)}</h4>
                      ${getAutoCategoryLabel(task.title)} </div>
                    ${timeString ? `<span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded shrink-0">${timeString}</span>` : ''}
                  </div>
                  ${task.content ? `<p class="text-sm text-gray-600 mt-1 break-words">${escapeHTML(task.content)}</p>` : ''}
                  ${renderMemoLink(task.memo)}
                </div>
                <div class="flex flex-col gap-1 shrink-0">
                  <button onclick="event.stopPropagation(); openEditModal(${task.id})" class="p-1.5 text-gray-400 hover:text-dusty-blue-500 hover:bg-dusty-blue-50 rounded-md transition-colors"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                  <button onclick="event.stopPropagation(); deleteTask(${task.id})" class="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
                </div>
            </div>
          `;
        });
      }
      contentContainer.innerHTML = html;
      lucide.createIcons();
    }

 function openModal() { 
      editingTaskId = null;
      document.getElementById('add-task-form').reset();
      document.querySelector('#add-modal h2').textContent = '新規タスクの追加';
      document.getElementById('submit-btn').textContent = '登録する';
      document.getElementById('task-dueDate-specific').value = getLocalIsoDateTime();
      handleTypeChange();
      document.getElementById('add-modal').classList.remove('hidden'); 
    }

    function openEditModal(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      
      editingTaskId = id;
      document.querySelector('#add-modal h2').textContent = 'タスクの編集';
      document.getElementById('submit-btn').textContent = '保存する';
      
      // フォームに値をセット
      document.getElementById('task-title').value = task.title || '';
      document.getElementById('task-content').value = task.content || '';
      document.getElementById('task-type').value = task.type || 'specific';
      document.getElementById('task-memo').value = task.memo || '';
      
      handleTypeChange();
      
      // 日付のセット
      if (task.type === 'specific') {
        document.getElementById('task-dueDate-specific').value = task.dueDate;
      } else {
        // 繰り返しの場合は特定日時指定ラジオボタンをオンにする
        document.querySelector('input[name="dueDateOption"][value="exact"]').checked = true;
        handleDueDateOptionChange();
        document.getElementById('task-dueDate-recurring').value = task.dueDate;
      }
      
      document.getElementById('add-modal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('add-modal').classList.add('hidden'); }

    // --- フォーマット関数 ---
    function formatDateSimple(dateString) {
      const d = new Date(dateString);
      return `${d.getMonth() + 1}月${d.getDate()}日 (${['日','月','火','水','木','金','土'][d.getDay()]})`;
    }
    function formatDateTime(dateTimeStr) {
      if (!dateTimeStr) return '';
      const d = new Date(dateTimeStr);
      return `${d.getMonth() + 1}/${d.getDate()} (${['日','月','火','水','木','金','土'][d.getDay()]}) ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    }
    function getTypeLabel(t) {
      const m = {'daily':'毎日', 'weekly':'毎週', 'biweekly':'2週間毎', 'triweekly':'3週間毎', 'monthly':'毎月'};
      return m[t] || '特定';
    }
    function getDueDateColor(dStr) {
      const diff = new Date(dStr) - new Date();
      if (diff < 0) return 'bg-red-50 text-red-600 border border-red-100';
      if (diff <= 86400000) return 'bg-orange-50 text-orange-600 border border-orange-100';
      if (diff <= 259200000) return 'bg-yellow-50 text-yellow-700 border border-yellow-100';
      return 'bg-green-50 text-green-700 border border-green-100';
    }
    function escapeHTML(s) {
      if (!s) return '';
      return s.replace(/[&<>'"]/g, t => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[t] || t));
    }
    function renderMemoLink(m) {
      if (!m) return '';
      const esc = escapeHTML(m);
      return `<div class="whitespace-pre-wrap text-sm text-gray-600 mt-2 bg-gray-50 p-2.5 rounded border border-gray-100">${esc.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-dusty-blue-500 hover:text-dusty-blue-700 hover:underline break-all" onclick="event.stopPropagation()">$1</a>')}</div>`;
    }
  </script>
</body>
</html>
