<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { 'dusty-blue': { 50: '#f2f6f8', 100: '#dfe8ed', 200: '#c2d5e0', 300: '#99bcce', 400: '#6a9db6', 500: '#52839d', 600: '#466a81', 700: '#3a566a', 800: '#334858', 900: '#2e3e4b', } } } }
    }
  </script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .spinner {
      border: 2px solid #dfe8ed;
      border-top: 2px solid #52839d;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans pb-24 min-h-screen">

  <header class="bg-white shadow-sm sticky top-0 z-10 px-4 py-3">
    <div class="max-w-3xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-3">
        <h1 class="text-lg sm:text-xl font-bold text-dusty-blue-700 flex items-center gap-2">
          <i data-lucide="check-square" class="w-6 h-6"></i> タスク管理
        </h1>
        <div id="sync-indicator" class="spinner hidden" title="同期中..."></div>
      </div>
      
      <div class="flex bg-gray-100 p-1 rounded-lg">
        <button id="tab-list" onclick="setView('list')" class="flex items-center gap-1.5 px-3 sm:px-4 py-1.5 rounded-md text-xs sm:text-sm font-bold transition-colors bg-white shadow-sm text-dusty-blue-600">
          <i data-lucide="list" class="w-4 h-4"></i> リスト
        </button>
        <button id="tab-calendar" onclick="setView('calendar')" class="flex items-center gap-1.5 px-3 sm:px-4 py-1.5 rounded-md text-xs sm:text-sm font-bold transition-colors text-gray-500 hover:text-gray-700">
          <i data-lucide="calendar" class="w-4 h-4"></i> カレンダー
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 mt-6">
    <div id="list-container">
      <div id="tabs-container" class="flex gap-2 overflow-x-auto no-scrollbar pb-2 mb-4 border-b border-gray-200">
        </div>
      <div id="view-list" class="space-y-3"></div>
    </div>

    <div id="calendar-container" class="hidden">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-4 flex justify-between items-center border-b border-gray-100">
          <button onclick="prevMonth()" class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600">
            <i data-lucide="chevron-left" class="w-5 h-5"></i>
          </button>
          <h2 id="calendar-title" class="text-lg font-bold text-gray-800"></h2>
          <button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600">
            <i data-lucide="chevron-right" class="w-5 h-5"></i>
          </button>
        </div>
        
        <div class="grid grid-cols-7 bg-gray-50 border-b border-gray-100">
          <div class="py-2 text-center text-xs font-medium text-red-500">日</div>
          <div class="py-2 text-center text-xs font-medium text-gray-500">月</div>
          <div class="py-2 text-center text-xs font-medium text-gray-500">火</div>
          <div class="py-2 text-center text-xs font-medium text-gray-500">水</div>
          <div class="py-2 text-center text-xs font-medium text-gray-500">木</div>
          <div class="py-2 text-center text-xs font-medium text-gray-500">金</div>
          <div class="py-2 text-center text-xs font-medium text-dusty-blue-500">土</div>
        </div>
        
        <div id="calendar-grid" class="grid grid-cols-7"></div>
      </div>
    </div>
  </main>

  <div id="day-detail-modal" class="hidden fixed inset-0 z-30 flex flex-col justify-end" onclick="closeDayDetailModal()">
    <div id="day-detail-backdrop" class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity duration-300 opacity-0"></div>
    <div id="day-detail-sheet" class="relative bg-white rounded-t-3xl shadow-2xl w-full max-w-2xl mx-auto overflow-hidden flex flex-col max-h-[85vh] transform translate-y-full transition-transform duration-300 ease-out" onclick="event.stopPropagation()">
      <div class="w-full flex justify-center pt-3 pb-2 bg-gray-50 cursor-pointer" onclick="closeDayDetailModal()">
        <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
      </div>
      <div class="flex justify-between items-center px-5 py-3 border-b border-gray-100 bg-gray-50">
        <h3 id="day-detail-title" class="font-bold text-gray-800 flex items-center gap-2"></h3>
        <button onclick="closeDayDetailModal()" class="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded-full transition-colors">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="day-detail-content" class="p-4 overflow-y-auto bg-gray-50 pb-12 no-scrollbar">
      </div>
    </div>
  </div>

  <button onclick="openModal()" class="fixed bottom-8 right-8 w-14 h-14 bg-dusty-blue-500 hover:bg-dusty-blue-600 text-white rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95 z-20">
    <i data-lucide="plus" class="w-7 h-7"></i>
  </button>

  <div id="add-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex justify-center items-end sm:items-center p-0 sm:p-4">
    <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
      <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-gray-50">
        <h2 id="modal-title" class="text-lg font-bold text-gray-800">新規タスク</h2>
        <button onclick="closeModal()" class="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded-full transition-colors">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-5 overflow-y-auto no-scrollbar bg-white">
        <form id="add-task-form" class="space-y-5">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">やること <span class="text-red-500">*</span></label>
            <input type="text" id="task-title" required placeholder="例: 提案書の作成" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 outline-none transition-all">
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-1">カテゴリ</label>
              <select id="task-category" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 outline-none bg-white text-gray-700">
                <option value="その他">未分類 (その他)</option>
                <option value="仕事">仕事</option>
                <option value="日常">日常</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-1">繰り返し</label>
              <select id="task-type" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 outline-none bg-white text-gray-700">
                <option value="specific">1回のみ</option>
                <option value="daily">毎日</option>
                <option value="weekly">毎週</option>
                <option value="monthly">毎月</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">期日 <span class="text-xs font-normal text-gray-400">(任意)</span></label>
            <input type="datetime-local" id="task-dueDate" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 outline-none">
            <p class="text-xs text-gray-500 mt-1">※時間を指定しない場合は「23:59」とするのがおすすめです。</p>
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">メモ / 内容</label>
            <textarea id="task-memo" rows="3" placeholder="補足情報やURLなど" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dusty-blue-400 outline-none resize-none"></textarea>
          </div>
        </form>
      </div>

      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
        <button type="button" onclick="closeModal()" class="px-5 py-2.5 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">キャンセル</button>
        <button type="submit" id="submit-btn" form="add-task-form" class="px-5 py-2.5 text-sm font-medium text-white bg-dusty-blue-500 rounded-lg hover:bg-dusty-blue-600 shadow-sm">保存する</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyNJU9XMMYJOBD_E7412_yNHtGNI4CyaU9jKL3w6nD6iK7L2kDFUoAohoXGZEC9aSbbWg/exec';
    
    // --- 状態管理 ---
    let tasks = [];
    let isSyncing = false;
    let editingTaskId = null;
    let currentFilter = 'today'; // リスト側のタブ
    let currentView = 'list';    // 全体のビュー（list or calendar）
    let currentDate = new Date(); // カレンダー表示用の年月
    let selectedDate = null;      // カレンダーで選択した日付

    // --- APIラッパー ---
    async function fetchAPI(action, payload = {}) {
      setSyncing(true);
      try {
        const res = await fetch(GAS_WEB_APP_URL, {
          method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: action, ...payload })
        });
        const json = await res.json();
        if (json.status === 'error') throw new Error(json.message);
        return json.data;
      } finally {
        setSyncing(false);
      }
    }

    function setSyncing(status) {
      isSyncing = status;
      document.getElementById('sync-indicator').classList.toggle('hidden', !status);
    }

    // --- 初期化 ---
    document.addEventListener('DOMContentLoaded', () => {
      loadAllTasks();

      document.getElementById('add-task-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = document.getElementById('task-title').value.trim();
        if (!title) return;

        const newTaskData = {
          title: title,
          category: document.getElementById('task-category').value,
          type: document.getElementById('task-type').value,
          dueDate: document.getElementById('task-dueDate').value,
          memo: document.getElementById('task-memo').value,
          content: '', 
        };

        if (editingTaskId) {
          const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
          if (taskIndex !== -1) {
            Object.assign(tasks[taskIndex], newTaskData);
            closeModal();
            renderApp();
            if (selectedDate) renderDayDetailModalContent();
            
            try {
              await fetchAPI('editTask', { task: tasks[taskIndex] });
              await fetchFromServer();
            } catch (error) {
              alert('更新に失敗しました。');
              await loadAllTasks();
            }
          }
        } else {
          const newTask = {
            id: Date.now(),
            registerDate: new Date().toISOString().slice(0, 10),
            completed: false,
            count: 0,
            ...newTaskData
          };

          tasks.push(newTask);
          closeModal();
          renderApp();
          
          try {
            await fetchAPI('addTask', { task: newTask });
            await fetchFromServer();
          } catch (error) {
            alert('登録に失敗しました。');
            await loadAllTasks();
          }
        }
      });
    });

    async function loadAllTasks() {
      const cached = localStorage.getItem('task_manager_cache');
      if (cached) {
        try { tasks = JSON.parse(cached); renderApp(); } catch(e){}
      }
      await fetchFromServer();
    }

    async function fetchFromServer() {
      try {
        const serverTasks = await fetchAPI('getTasks');
        tasks = serverTasks;
        localStorage.setItem('task_manager_cache', JSON.stringify(tasks));
        renderApp();
      } catch (e) {
        console.error(e);
      }
    }

    async function completeTask(id) {
      tasks = tasks.filter(t => t.id !== id);
      renderApp();
      if (selectedDate) renderDayDetailModalContent();
      try {
        await fetchAPI('completeTask', { id });
        await fetchFromServer();
      } catch(e) {
        alert('エラーが発生しました');
        await fetchFromServer();
      }
    }

    async function deleteTask(id) {
      if(!confirm('本当に削除しますか？')) return;
      tasks = tasks.filter(t => t.id !== id);
      renderApp();
      if (selectedDate) renderDayDetailModalContent();
      try {
        await fetchAPI('deleteTask', { id });
        await fetchFromServer();
      } catch(e) {
        alert('エラーが発生しました');
        await fetchFromServer();
      }
    }

    // --- ロジック ---
    function getTaskStatus(dueDate) {
      if (!dueDate) return 'nodate';
      const now = new Date();
      const taskDate = new Date(dueDate);
      
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tmrw = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      const taskDay = new Date(taskDate.getFullYear(), taskDate.getMonth(), taskDate.getDate());
      
      if (taskDate < now) return 'overdue'; 
      if (taskDay.getTime() === today.getTime()) return 'today';
      if (taskDay.getTime() === tmrw.getTime()) return 'tomorrow';
      return 'upcoming';
    }

    // ビューの切り替え（リスト⇔カレンダー）
    function setView(view) {
      currentView = view;
      const tabList = document.getElementById('tab-list');
      const tabCal = document.getElementById('tab-calendar');
      const activeClass = "flex items-center gap-1.5 px-3 sm:px-4 py-1.5 rounded-md text-xs sm:text-sm font-bold transition-colors bg-white shadow-sm text-dusty-blue-600";
      const inactiveClass = "flex items-center gap-1.5 px-3 sm:px-4 py-1.5 rounded-md text-xs sm:text-sm font-bold transition-colors text-gray-500 hover:text-gray-700";

      if (view === 'list') {
        tabList.className = activeClass;
        tabCal.className = inactiveClass;
      } else {
        tabCal.className = activeClass;
        tabList.className = inactiveClass;
      }
      renderApp();
    }

    // 画面全体の描画
    function renderApp() {
      if (currentView === 'list') {
        document.getElementById('list-container').classList.remove('hidden');
        document.getElementById('calendar-container').classList.add('hidden');
        renderTabs();
        renderList();
      } else {
        document.getElementById('list-container').classList.add('hidden');
        document.getElementById('calendar-container').classList.remove('hidden');
        renderCalendar();
      }
      lucide.createIcons();
    }

    // ▼ リスト側の描画関数 ▼
    function renderTabs() {
      const container = document.getElementById('tabs-container');
      const counts = { overdue: 0, today: 0, tomorrow: 0, upcoming: 0, nodate: 0, all: tasks.length };
      tasks.forEach(t => {
        const status = getTaskStatus(t.dueDate);
        counts[status] = (counts[status] || 0) + 1;
      });

      const tabsData = [
        { id: 'today', label: '今日', count: counts.today },
        { id: 'tomorrow', label: '明日', count: counts.tomorrow },
        { id: 'upcoming', label: '以降', count: counts.upcoming },
        { id: 'nodate', label: '期日なし', count: counts.nodate },
        { id: 'all', label: 'すべて', count: counts.all },
      ];

      if (counts.overdue > 0) {
        tabsData.unshift({ id: 'overdue', label: '期限切れ', count: counts.overdue, isAlert: true });
      }

      let html = '';
      tabsData.forEach(tab => {
        const isActive = currentFilter === tab.id;
        const baseClass = "px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all flex items-center gap-1.5 cursor-pointer";
        
        let activeClass, inactiveClass, badgeClass;
        if (tab.isAlert) {
          activeClass = "bg-red-500 text-white shadow-md";
          inactiveClass = "bg-red-50 text-red-600 border border-red-200 hover:bg-red-100";
          badgeClass = isActive ? "bg-white text-red-600" : "bg-red-500 text-white";
        } else {
          activeClass = "bg-dusty-blue-600 text-white shadow-md";
          inactiveClass = "bg-white text-gray-600 border border-gray-200 hover:bg-gray-50";
          badgeClass = isActive ? "bg-white text-dusty-blue-600" : "bg-gray-200 text-gray-600";
        }

        const badgeHtml = tab.count > 0 ? `<span class="px-1.5 py-0.5 rounded-full text-[10px] ${badgeClass}">${tab.count}</span>` : '';
        html += `<button onclick="currentFilter='${tab.id}'; renderApp();" class="${baseClass} ${isActive ? activeClass : inactiveClass}">${tab.label} ${badgeHtml}</button>`;
      });
      container.innerHTML = html;
    }

    function renderList() {
      const container = document.getElementById('view-list');
      let filteredTasks = tasks.filter(t => {
        if (currentFilter === 'all') return true;
        return getTaskStatus(t.dueDate) === currentFilter;
      });

      filteredTasks.sort((a, b) => {
        if (!a.dueDate && !b.dueDate) return 0;
        if (!a.dueDate) return 1;
        if (!b.dueDate) return -1;
        return new Date(a.dueDate) - new Date(b.dueDate);
      });

      if (filteredTasks.length === 0) {
        container.innerHTML = `<div class="text-center py-16 bg-white rounded-xl shadow-sm border border-gray-100"><div class="text-gray-300 flex justify-center mb-3"><i data-lucide="inbox" class="w-10 h-10"></i></div><p class="text-gray-500 font-medium">タスクはありません</p></div>`;
        return;
      }

      let html = '';
      filteredTasks.forEach(task => {
        let dueDateHtml = '';
        if (task.dueDate) {
          const status = getTaskStatus(task.dueDate);
          let colorClass = 'bg-green-50 text-green-700 border-green-200';
          if (status === 'overdue') colorClass = 'bg-red-50 text-red-600 border-red-200 font-bold';
          else if (status === 'today') colorClass = 'bg-orange-50 text-orange-600 border-orange-200 font-bold';
          dueDateHtml = `<div class="text-[11px] px-2 py-0.5 rounded border flex items-center gap-1 shrink-0 ${colorClass}"><i data-lucide="calendar" class="w-3 h-3"></i>${formatDateTime(task.dueDate)}</div>`;
        }

        const catBadge = `<span class="text-[10px] px-2 py-0.5 border rounded-full bg-gray-50 text-gray-600 border-gray-200 shrink-0">${task.category || 'その他'}</span>`;
        const repeatBadge = task.type !== 'specific' ? `<span class="text-[10px] px-2 py-0.5 bg-dusty-blue-50 text-dusty-blue-600 rounded-full shrink-0"><i data-lucide="repeat" class="w-2.5 h-2.5 inline mr-0.5"></i>${getTypeLabel(task.type)}</span>` : '';

        html += `
          <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex gap-3 transition-all hover:border-dusty-blue-300 group">
            <div class="pt-0.5">
              <button onclick="completeTask(${task.id})" class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-transparent hover:border-dusty-blue-500 hover:text-dusty-blue-500 transition-colors"><i data-lucide="check" class="w-3.5 h-3.5" stroke-width="3"></i></button>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between gap-2 mb-1">
                <h3 class="font-bold text-gray-800 text-base leading-tight break-words">${escapeHTML(task.title)}</h3>
                ${dueDateHtml}
              </div>
              <div class="flex flex-wrap items-center gap-1.5 mb-2">
                ${catBadge}
                ${getAutoCategoryLabel(task.title)}
                ${repeatBadge}
              </div>
              ${renderMemoLink(task.memo)}
            </div>
            <div class="flex flex-col gap-1.5 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
              <button onclick="openEditModal(${task.id})" class="p-1.5 text-gray-400 hover:text-dusty-blue-600 bg-gray-50 hover:bg-dusty-blue-50 rounded-lg"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
              <button onclick="deleteTask(${task.id})" class="p-1.5 text-gray-400 hover:text-red-600 bg-gray-50 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // ▼ カレンダー側の描画関数 ▼
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      document.getElementById('calendar-title').textContent = `${year}年 ${month + 1}月`;

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const firstDayOfMonth = new Date(year, month, 1).getDay();
      const todayString = getLocalIsoDateTime().slice(0, 10);

      let gridHtml = '';
      for (let i = 0; i < firstDayOfMonth; i++) gridHtml += `<div class="border-b border-r border-gray-100 bg-gray-50/50 min-h-[70px] sm:min-h-[90px]"></div>`;

      for (let i = 1; i <= daysInMonth; i++) {
        const d = new Date(year, month, i);
        const dateString = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
        const isToday = dateString === todayString;
        
        // 期日ありのものだけ抽出
        const dateTasks = tasks.filter(t => t.dueDate && t.dueDate.startsWith(dateString));

        let taskHtml = '';
        dateTasks.forEach(task => {
          taskHtml += `<div class="text-[9px] sm:text-[10px] truncate px-1 py-0.5 rounded bg-dusty-blue-100 text-dusty-blue-700 mb-0.5">${escapeHTML(task.title)}</div>`;
        });

        gridHtml += `
          <div onclick="selectDate('${dateString}')" class="border-b border-r border-gray-100 p-1 relative group hover:bg-dusty-blue-50/50 cursor-pointer transition-colors overflow-hidden min-h-[70px] sm:min-h-[90px]">
            <div class="flex justify-between items-start mb-1">
              <span class="text-xs sm:text-sm font-medium w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-dusty-blue-500 text-white shadow-sm' : 'text-gray-700'}">${i}</span>
            </div>
            <div class="flex flex-col">${taskHtml}</div>
          </div>
        `;
      }
      document.getElementById('calendar-grid').innerHTML = gridHtml;
    }

    function prevMonth() { currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1); renderApp(); }
    function nextMonth() { currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1); renderApp(); }

    function selectDate(dateString) {
      selectedDate = dateString;
      renderDayDetailModalContent();
      document.getElementById('day-detail-modal').classList.remove('hidden');
      requestAnimationFrame(() => {
        document.getElementById('day-detail-backdrop').classList.remove('opacity-0');
        document.getElementById('day-detail-sheet').classList.remove('translate-y-full');
      });
    }

    function closeDayDetailModal() {
      document.getElementById('day-detail-backdrop').classList.add('opacity-0');
      document.getElementById('day-detail-sheet').classList.add('translate-y-full');
      setTimeout(() => {
        document.getElementById('day-detail-modal').classList.add('hidden');
        selectedDate = null;
      }, 300);
    }

    function renderDayDetailModalContent() {
      if (!selectedDate) return;
      const contentContainer = document.getElementById('day-detail-content');
      document.getElementById('day-detail-title').innerHTML = `<i data-lucide="calendar" class="w-5 h-5 text-dusty-blue-500"></i> ${formatDateSimple(selectedDate)} のタスク`;
      
      const dateTasks = tasks.filter(t => t.dueDate && t.dueDate.startsWith(selectedDate)).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
      
      let html = '';
      if (dateTasks.length === 0) {
        html = `<div class="text-center py-8 text-gray-500"><p>この日のタスクはありません。</p></div>`;
      } else {
        dateTasks.forEach(task => {
          const timeString = task.dueDate.split('T')[1];
          const catBadge = `<span class="text-[10px] px-2 py-0.5 border rounded-full bg-gray-100 text-gray-600 border-gray-200 shrink-0">${task.category || 'その他'}</span>`;
          const repeatBadge = task.type !== 'specific' ? `<span class="text-[10px] px-2 py-0.5 bg-dusty-blue-50 text-dusty-blue-600 rounded-full shrink-0"><i data-lucide="repeat" class="w-2.5 h-2.5 inline mr-0.5"></i>${getTypeLabel(task.type)}</span>` : '';

          html += `
            <div class="bg-white p-3.5 rounded-xl shadow-sm border border-gray-100 flex gap-3 transition-all hover:border-dusty-blue-300 group mb-3">
              <div class="pt-0.5">
                <button onclick="event.stopPropagation(); completeTask(${task.id})" class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-transparent hover:border-dusty-blue-500 hover:text-dusty-blue-500 transition-colors"><i data-lucide="check" class="w-3.5 h-3.5" stroke-width="3"></i></button>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2 mb-1">
                  <h4 class="font-bold text-gray-800 text-[15px] leading-tight break-words">${escapeHTML(task.title)}</h4>
                  ${timeString ? `<span class="text-[11px] font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded shrink-0 border border-gray-200">${timeString}</span>` : ''}
                </div>
                <div class="flex flex-wrap items-center gap-1.5 mb-2">
                  ${catBadge}
                  ${getAutoCategoryLabel(task.title)}
                  ${repeatBadge}
                </div>
                ${renderMemoLink(task.memo)}
              </div>
              <div class="flex flex-col gap-1.5 shrink-0">
                <button onclick="event.stopPropagation(); openEditModal(${task.id})" class="p-1.5 text-gray-400 hover:text-dusty-blue-600 bg-gray-50 hover:bg-dusty-blue-50 rounded-lg"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                <button onclick="event.stopPropagation(); deleteTask(${task.id})" class="p-1.5 text-gray-400 hover:text-red-600 bg-gray-50 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
              </div>
            </div>
          `;
        });
      }
      contentContainer.innerHTML = html;
      lucide.createIcons();
    }

    // --- UI/UX Helpers ---
    function openModal() {
      editingTaskId = null;
      document.getElementById('add-task-form').reset();
      document.getElementById('modal-title').textContent = '新規タスクの追加';
      
      const now = new Date();
      now.setHours(23, 59, 0, 0); 
      document.getElementById('task-dueDate').value = getLocalIsoDateTime(now);
      
      document.getElementById('add-modal').classList.remove('hidden');
    }

    function openEditModal(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      editingTaskId = id;
      document.getElementById('modal-title').textContent = 'タスクの編集';
      document.getElementById('task-title').value = task.title || '';
      document.getElementById('task-category').value = task.category || 'その他';
      document.getElementById('task-type').value = task.type || 'specific';
      document.getElementById('task-dueDate').value = task.dueDate || '';
      document.getElementById('task-memo').value = task.memo || '';
      
      document.getElementById('add-modal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('add-modal').classList.add('hidden'); }

    function getLocalIsoDateTime(d = new Date()) {
      return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    }
    function formatDateTime(str) {
      if (!str) return '';
      const d = new Date(str);
      const days = ['日','月','火','水','木','金','土'];
      return `${d.getMonth()+1}/${d.getDate()}(${days[d.getDay()]}) ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }
    function getTypeLabel(t) {
      const m = {'daily':'毎日', 'weekly':'毎週', 'biweekly':'2週毎', 'triweekly':'3週毎', 'monthly':'毎月'};
      return m[t] || '';
    }
    function getAutoCategoryLabel(title) {
      const rules = [
        { k: ['会議','mtg','打合'], c: 'bg-red-100 text-red-700 border-red-200' },
        { k: ['開発','実装','コード','バグ'], c: 'bg-blue-100 text-blue-700 border-blue-200' },
        { k: ['資料','提案書','作成'], c: 'bg-emerald-100 text-emerald-700 border-emerald-200' },
        { k: ['連絡','メール','電話','確認'], c: 'bg-amber-100 text-amber-700 border-amber-200' },
        { k: ['重要','至急'], c: 'bg-purple-100 text-purple-700 border-purple-200 font-bold' }
      ];
      for (let r of rules) {
        if (r.k.some(kw => title.toLowerCase().includes(kw))) 
          return `<span class="text-[10px] px-2 py-0.5 border rounded-full shrink-0 ${r.c}">${r.k[0]}</span>`;
      }
      return '';
    }
    function escapeHTML(s) {
      return s ? s.replace(/[&<>'"]/g, t => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[t]||t)) : '';
    }
    function renderMemoLink(m) {
      if (!m) return '';
      const esc = escapeHTML(m);
      const text = esc.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-dusty-blue-500 hover:underline break-all" onclick="event.stopPropagation()">$1</a>');
      return `<div class="text-[13px] text-gray-600 mt-2 bg-gray-50 p-2.5 rounded border border-gray-100 whitespace-pre-wrap">${text}</div>`;
    }
  </script>
</body>
</html>
